<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="loading.css">
    <title>Document</title>
</head>

<body>
    <div id="contenedor">
        <div class="loader" id="loader">Loading...</div>
    </div>

    <div id="svg" hidden>
        <svg xmlns='http://www.w3.org/2000/svg'>

            <g id="BB1">
                <path fill="#FFDC00"
                    d="M19.941,15.751c0-1.16,0-6.147,0-6.147c0-0.932-0.756-1.687-1.688-1.687s-1.687,0.755-1.687,1.687v4.724
                                                                        c0,0,0.194,0.008,1.186,0C18.598,14.369,19.654,14.576,19.941,15.751z" />
                <path fill="#FFDC00"
                    d="M0,15.751c0-1.16,0-6.147,0-6.147c0-0.932,0.756-1.687,1.688-1.687s1.687,0.755,1.687,1.687v4.724
                                                                        c0,0-0.194,0.008-1.186,0C1.344,14.369,0.287,14.576,0,15.751z" />
                <path fill="#FFDC00"
                    d="M3.943,9.604v4.724H9.97h6.027V9.604c0-1.227,1.013-2.225,2.257-2.225V5.914
                                                                        C18.254,2.648,15.569,0,12.257,0H9.97H7.685C4.373,0,1.688,2.648,1.688,5.914v1.464C2.932,7.378,3.943,8.376,3.943,9.604z" />
                <path fill="#FFDC00"
                    d="M19.941,17.006c0-1.207-0.979-2.187-2.187-2.187H2.187C0.979,14.819,0,15.799,0,17.006l0,0
                                                                        c0,1.207,0.979,2.187,2.187,2.187h15.568C18.962,19.192,19.941,18.213,19.941,17.006L19.941,17.006z" />
                <rect x="3.964" y="12.349" opacity="0.1" width="12.033" height="1.979" />
                <g>
                    <path d="M9.957,5.309H9.938L8.833,5.835L8.611,4.819l1.532-0.713h1.123v5.792h-1.31V5.309z" />
                </g>
            </g>

            <g id="BB2">
                <path fill="#FFDC00"
                    d="M44.443,16.054c0-1.16,0-6.148,0-6.148c0-0.932-0.756-1.687-1.688-1.687S41.07,8.974,41.07,9.906v4.724
                                                    c0,0,0.193,0.008,1.186,0C43.1,14.671,44.156,14.878,44.443,16.054z" />
                <path fill="#FFDC00"
                    d="M24.502,16.054c0-1.16,0-6.148,0-6.148c0-0.932,0.756-1.687,1.688-1.687s1.688,0.755,1.688,1.687v4.724
                                                    c0,0-0.195,0.008-1.186,0C25.846,14.671,24.789,14.878,24.502,16.054z" />
                <path fill="#FFDC00" d="M28.445,9.906v4.724h6.027H40.5V9.906c0-1.227,1.012-2.225,2.256-2.225V6.216
                                                    c0-3.266-2.684-5.914-5.996-5.914h-2.287h-2.285c-3.312,0-5.998,2.648-5.998,5.914v1.464C27.434,7.681,28.445,8.679,28.445,9.906
                                                    z" />
                <path fill="#FFDC00"
                    d="M44.443,17.308c0-1.207-0.979-2.186-2.186-2.186H26.689c-1.207,0-2.188,0.979-2.188,2.186l0,0
                                                    c0,1.207,0.98,2.188,2.188,2.188h15.568C43.465,19.495,44.443,18.515,44.443,17.308L44.443,17.308z" />
                <rect x="28.467" y="12.651" opacity="0.1" width="12.033" height="1.979" />
                <g>
                    <path
                        d="M32.729,10.201v-0.82l0.749-0.677c1.266-1.132,1.88-1.782,1.897-2.459c0-0.472-0.285-0.847-0.953-0.847
                                                        c-0.499,0-0.936,0.25-1.238,0.481L32.8,4.908c0.437-0.33,1.114-0.597,1.898-0.597c1.31,0,2.031,0.766,2.031,1.818
                                                        c0,0.971-0.703,1.747-1.541,2.495l-0.535,0.445v0.018h2.184v1.114H32.729z" />
                </g>
            </g>

            <g id="BB3">
                <path fill="#FFDC00"
                    d="M69.147,16.054c0-1.16,0-6.148,0-6.148c0-0.932-0.756-1.687-1.688-1.687s-1.686,0.755-1.686,1.687v4.725
                                                        c0,0,0.193,0.008,1.186,0C67.804,14.671,68.86,14.878,69.147,16.054z" />
                <path fill="#FFDC00"
                    d="M49.206,16.054c0-1.16,0-6.148,0-6.148c0-0.932,0.756-1.687,1.688-1.687s1.688,0.755,1.688,1.687v4.725
                                                        c0,0-0.195,0.008-1.186,0C50.55,14.671,49.493,14.878,49.206,16.054z" />
                <path fill="#FFDC00"
                    d="M53.149,9.905v4.725h6.027h6.027V9.905c0-1.227,1.012-2.225,2.256-2.225V6.216
                                                        c0-3.266-2.684-5.914-5.996-5.914h-2.287h-2.285c-3.312,0-5.998,2.648-5.998,5.914V7.68C52.138,7.68,53.149,8.678,53.149,9.905z" />
                <path fill="#FFDC00"
                    d="M69.147,17.308c0-1.207-0.979-2.186-2.186-2.186H51.394c-1.207,0-2.188,0.979-2.188,2.186l0,0
                                                        c0,1.207,0.98,2.188,2.188,2.188h15.568C68.169,19.495,69.147,18.515,69.147,17.308L69.147,17.308z" />
                <rect x="53.171" y="12.651" opacity="0.1" width="12.033" height="1.979" />
                <g>
                    <path
                        d="M57.675,8.874c0.24,0.125,0.793,0.356,1.346,0.356c0.703,0,1.06-0.339,1.06-0.775c0-0.57-0.57-0.829-1.167-0.829h-0.553
                                                            V6.654h0.526c0.454-0.009,1.033-0.178,1.033-0.668c0-0.348-0.285-0.606-0.855-0.606c-0.472,0-0.972,0.205-1.212,0.347
                                                            l-0.276-0.98c0.348-0.223,1.043-0.437,1.791-0.437c1.239,0,1.925,0.65,1.925,1.443c0,0.615-0.348,1.096-1.061,1.346v0.018
                                                            c0.695,0.125,1.257,0.65,1.257,1.408c0,1.025-0.899,1.773-2.37,1.773c-0.749,0-1.381-0.196-1.72-0.41L57.675,8.874z" />
                </g>
            </g>
            <g id="Palco_DERECHA_BB">
                <rect fill="black" opacity="0" width="69.148" height="19.494" />
            </g>
        </svg>
    </div>


    <script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>

    <script src="token.js"></script>
    <script>

        var token = "";

        if (!sessionStorage.getItem('token')) {
            token = generarToken();
            sessionStorage.setItem('token', token);
        }

        if (sessionStorage.getItem('token')) {
            token = sessionStorage.getItem('token');
        }

        console.log("Token => " + token);



        var sombra = document.getElementById("Palco_DERECHA_BB");
        sombra.remove();

        firebase.initializeApp({
            apiKey: 'AIzaSyDJylVWdHVt64-cxjyZ2K29N0f15IrWliM',
            authDomain: 'mapa-9c58d.firebaseapp.com',
            projectId: 'mapa-9c58d'
        });

        function actualizarSeleccionado(documento, asiento) {
            return documento.update({
                status: 'seleccionado',
                tokenUser: token,
                horaStatus: new Date().getTime()
            })
                .then(() => {
                    console.log("Document successfully updated!");
                    asiento.setAttribute("data-first", false);
                    asiento.style.cursor = "pointer";
                })
                .catch((error) => {
                    console.log("Error => " + error);
                })
        }

        function actualizarDisponible(documento, asiento) {
            return documento.update({
                status: 'disponible',
                tokenUser: '',
                horaStatus: ''
            })
                .then(() => {
                    console.log("Document successfully updated!");
                    asiento.setAttribute("data-first", true);
                })
                .catch((error) => {
                    console.error("Error updating document: ", error);
                })
        }

        function verificarCambio(coleccion, id) {
            coleccion.where("idJS", "==", id)
                .get()
                .then(function (querySnapshot) {
                    querySnapshot.forEach(function (doc) {
                        var auxiliar = doc.data().tokenUser;

                        if (auxiliar == token) {
                            Swal.fire({
                                title: 'Yeah!',
                                text: 'Has seleccionado el asiento B' + id + " de forma correcta",
                                type: 'success',
                                confirmButtonText: 'Ok'
                            })
                        } else {
                            Swal.fire({
                                title: 'Ooops...',
                                text: 'Lo sentimos alguien mas selecciono tu asiento',
                                type: 'error',
                                confirmButtonText: 'Ok'
                            })
                        }
                    });
                })
                .catch(function (error) {
                    console.log("Error getting documents: ", error);
                });
        }

        function cambiarEstadoFirebase(id) {

            var asiento = document.querySelector("#" + id);
            var idFirebase = asiento.getAttribute("data-fs");
            var primeraVez = asiento.getAttribute("data-first");

            var coleccion = db.collection("idEvento");
            var documento = coleccion.doc(idFirebase);


            coleccion.where("idJS", "==", id)
                .get()
                .then(function (querySnapshot) {
                    querySnapshot.forEach(function (doc) {
                        var tokenUser = doc.data().tokenUser;
                        console.log("Token user => " + tokenUser);
                        if (tokenUser == token || tokenUser == '') {
                            //  alert("Puedes modificar");
                            if (primeraVez == 'true') {
                                actualizarSeleccionado(documento, asiento);
                                verificarCambio(coleccion, id);
                            }

                            if (primeraVez == 'false') {
                                actualizarDisponible(documento, asiento);
                            }
                        } else {
                            Swal.fire({
                                title: 'Ooops...',
                                text: 'Lo sentimos alguien mas selecciono tu asiento',
                                type: 'error',
                                confirmButtonText: 'Ok'
                            })
                        }
                    });
                })
                .catch(function (error) {
                    console.log("Error getting documents: ", error);
                });
        }

        function cambiarEstadoFirebaseExpirado(idFirebase) {

            var actualizarEstado = db.collection("idEvento").doc(idFirebase);

            return actualizarEstado.update({
                horaStatus: '',
                tokenUser: '',
                status: 'disponible'
            })
                .then(() => {
                    console.log("Document successfully updated!");
                })
                .catch((error) => {
                    console.error("Error updating document: ", error);
                })


        }

        function cambiarColorSeleccionado(elem) {
            var asiento = elem.children;
            for (var i = 0; i <= 3; i++) {
                asiento[i].setAttribute('fill', '#FFFF98');
            }
        }

        function cambiarColorOcupado(elem) {
            var asiento = elem.children;
            for (var i = 0; i <= 3; i++) {
                asiento[i].setAttribute('fill', '#D1AB00');
            }
        }

        function cambiarColorLibre(elem) {
            var asiento = elem.children;
            for (var i = 0; i <= 3; i++) {
                asiento[i].setAttribute('fill', '#FFDC00');
            }
        }

        var db = firebase.firestore();
        /**
         * 
         * Se llenan todos los asientos y se pintan. 
         * 
         */
        function llenarAsientos() {
            db.collection("idEvento")
                .get()
                .then(function (querySnapshot) {

                    var tiempoActual = new Date().getTime();

                    querySnapshot.forEach(function (doc) {

                        var idJS = doc.data().idJS;
                        var status = doc.data().status;
                        var idFirebase = doc.id;
                        var horaStatus = doc.data().horaStatus;
                        var tokenUser = doc.data().tokenUser;
                        var limiteTiempo = 1000 * 60 * 5;
                        var tiempoTranscurrido = tiempoActual - horaStatus;
                        console.log("Tiempo actual => " + tiempoActual);
                        console.log("Tiempo transcurrido => " + tiempoTranscurrido);

                        if (horaStatus != '' && status != 'ocupado') {
                            if (tiempoTranscurrido > limiteTiempo) {
                                cambiarEstadoFirebaseExpirado(idFirebase);
                                console.log("Asiento liberado => " + idJS);
                            }
                        }

                        var asiento = document.querySelector("#" + idJS);
                        asiento.setAttribute('data-fs', idFirebase);
                        asiento.setAttribute('data-first', true);
                        var i = 1;

                        if (status === 'disponible') {
                            asiento.style.cursor = 'pointer';
                            asiento.setAttribute('onclick', 'cambiarEstadoFirebase("' + idJS + '")');
                        }

                        if (status === 'seleccionado') {
                            cambiarColorSeleccionado(asiento);
                            if (tokenUser == token) {
                                asiento.style.cursor = 'pointer';
                                asiento.setAttribute('onclick', 'cambiarEstadoFirebase("' + idJS + '")');
                                asiento.setAttribute('data-first', false);  
                            }
                        }

                        if (status === 'ocupado') {
                            cambiarColorOcupado(asiento);
                        }

                    });
                })
                .then(() => {
                    var contenedor = document.querySelector("#contenedor");
                    var svg = document.querySelector("#svg");

                    contenedor.remove();
                    svg.removeAttribute('hidden');
                })
                .catch(function (error) {
                    console.log("Error getting documents: ", error);
                });
        }

        // Escucha de modificaciones
        function listenerFireBase() {
            db.collection("idEvento")
                .onSnapshot(function (querySnapshot) {
                    querySnapshot.forEach(function (doc) {

                        var idJS = doc.data().idJS;
                        var status = doc.data().status;

                        var asiento = document.querySelector("#" + idJS);


                        if (status === 'disponible') {
                            cambiarColorLibre(asiento);
                            asiento.style.cursor = 'pointer';
                            asiento.setAttribute('onclick', 'cambiarEstadoFirebase("' + idJS + '")');
                        }

                        if (status === 'seleccionado') {
                            cambiarColorSeleccionado(asiento);
                        }

                        if (status === 'ocupado') {
                            cambiarColorOcupado(asiento);
                            asiento.removeAttribute('style');
                            asiento.removeAttribute('onclick');
                        }
                    });
                });

        }

        llenarAsientos();
        listenerFireBase();
    </script>



    <script>

        /*
        var bb2 = document.querySelector('#BB2').children;
        console.log(bb2);

        for (var i = 0; i <= 3; i++) {
            bb2[i].setAttribute('fill', '#D1AB00');
        }

        var bb3 = document.querySelector('#BB3').children;
        console.log(bb2);

        for (var i = 0; i <= 3; i++) {
            bb3[i].setAttribute('fill', '#FFFF98');
        }

        var zona = document.querySelector('#Palco_DERECHA_BB').children;
        console.log(zona);

        zona[0].addEventListener('mouseover', () => {
            zona[0].setAttribute('opacity', '.5');
        })

        zona[0].addEventListener('mouseout', () => {
            zona[0].setAttribute('opacity', '0');
        })
        */

    </script>

</body>

</html>